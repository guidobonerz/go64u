package util

import (
	"fmt"
	"image/color"
	"log"
	"os"
	"strconv"

	"github.com/spf13/cobra"
	"github.com/spf13/pflag"
)

var Reset = "\033[0m"
var Red = "\033[31m"
var Green = "\033[32m"
var Yellow = "\033[33m"
var Blue = "\033[34m"
var Magenta = "\033[35m"
var Cyan = "\033[36m"
var Gray = "\033[37m"
var White = "\033[97m"

func RedText(text string) string {
	return fmt.Sprintf("\033[31m%s\033[0m", text)
}
func WhiteText(text string) string {
	return fmt.Sprintf("\033[97m%s\033[0m", text)
}
func YellowText(text string) string {
	return fmt.Sprintf("\033[33m%s\033[0m", text)
}
func GreenText(text string) string {
	return fmt.Sprintf("\033[32m%s\033[0m", text)
}
func BlueText(text string) string {
	return fmt.Sprintf("\033[34m%s\033[0m", text)
}

var ASCIIToScreenCodeLowercase = [128]byte{
	// 0x00-0x1F: Control characters
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
	0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,

	// 0x20-0x3F: Space, punctuation, numbers
	0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
	0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F,
	0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,

	// 0x40-0x5F: @, uppercase letters, brackets
	0x00,                                           // @
	0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, // A-H
	0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, // I-P
	0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, // Q-X
	0x19, 0x1A, // Y-Z
	0x1B, 0x1C, 0x1D, 0x1E, 0x1F, // [ \ ] ^ _

	// 0x60-0x7F: lowercase letters (use shifted character set codes)
	0x40,                                           // `
	0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, // a-h (lowercase screen codes)
	0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50, // i-p
	0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, // q-x
	0x59, 0x5A, // y-z
	0x3B, 0x3C, 0x3D, 0x3E, 0x3F, // { | } ~ DEL
}
var ASCIIToPETSCII = [128]byte{
	// 0x00-0x1F: Control characters
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
	0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F,

	// 0x20-0x3F: Space, punctuation, numbers
	0x20, // Space
	0x21, // !
	0x22, // "
	0x23, // #
	0x24, // $
	0x25, // %
	0x26, // &
	0x27, // '
	0x28, // (
	0x29, // )
	0x2A, // *
	0x2B, // +
	0x2C, // ,
	0x2D, // -
	0x2E, // .
	0x2F, // /
	0x30, // 0
	0x31, // 1
	0x32, // 2
	0x33, // 3
	0x34, // 4
	0x35, // 5
	0x36, // 6
	0x37, // 7
	0x38, // 8
	0x39, // 9
	0x3A, // :
	0x3B, // ;
	0x3C, // <
	0x3D, // =
	0x3E, // >
	0x3F, // ?

	// 0x40-0x5F: @, uppercase letters, brackets
	0x40, // @
	0x41, // A
	0x42, // B
	0x43, // C
	0x44, // D
	0x45, // E
	0x46, // F
	0x47, // G
	0x48, // H
	0x49, // I
	0x4A, // J
	0x4B, // K
	0x4C, // L
	0x4D, // M
	0x4E, // N
	0x4F, // O
	0x50, // P
	0x51, // Q
	0x52, // R
	0x53, // S
	0x54, // T
	0x55, // U
	0x56, // V
	0x57, // W
	0x58, // X
	0x59, // Y
	0x5A, // Z
	0x5B, // [
	0x5C, // \ (pound sign in PETSCII)
	0x5D, // ]
	0x5E, // ^ (up arrow in PETSCII)
	0x5F, // _ (left arrow in PETSCII)

	// 0x60-0x7F: Backtick, lowercase letters (mapped to uppercase in PETSCII)
	0x60, // ` (actually displays as graphics character in PETSCII)
	0x41, // a -> A (PETSCII uppercase)
	0x42, // b -> B
	0x43, // c -> C
	0x44, // d -> D
	0x45, // e -> E
	0x46, // f -> F
	0x47, // g -> G
	0x48, // h -> H
	0x49, // i -> I
	0x4A, // j -> J
	0x4B, // k -> K
	0x4C, // l -> L
	0x4D, // m -> M
	0x4E, // n -> N
	0x4F, // o -> O
	0x50, // p -> P
	0x51, // q -> Q
	0x52, // r -> R
	0x53, // s -> S
	0x54, // t -> T
	0x55, // u -> U
	0x56, // v -> V
	0x57, // w -> W
	0x58, // x -> X
	0x59, // y -> Y
	0x5A, // z -> Z
	0x7B, // {
	0x7C, // |
	0x7D, // }
	0x7E, // ~
	0x7F, // DEL
}

func GetWordAsString(address string) string {
	return fmt.Sprintf("%04X", GetWord(address))
}

func GetByteAsString(address string) string {
	return fmt.Sprintf("%02X", GetByte(address))
}

func GetWord(address string) int64 {
	value, _ := strconv.ParseInt(address, 16, 64)
	if value < 0 && value > 0xffff {
		panic("value MUST between 0000 and ffff")
	}
	return value
}

func GetByte(byte string) int64 {
	value, _ := strconv.ParseInt(byte, 16, 64)
	if value < 0 && value > 0xffff {
		panic("value MUST between 0000 and ff")
	}
	return value
}

func GetWordFromArray(offset int, data []byte) int {
	return int(data[offset+1])<<8 | int(data[offset])
}

func GetByteFromArray(offset int, data []byte) int {
	return int(data[offset])
}

func GetPalette() color.Palette {
	return color.Palette{
		color.RGBA{0x00, 0x00, 0x00, 255}, // 0: Black
		color.RGBA{0xff, 0xff, 0xff, 255}, // 1: White
		color.RGBA{0xaf, 0x2a, 0x29, 255}, // 2: Red
		color.RGBA{0x62, 0xd8, 0xcc, 255}, // 3: Cyan
		color.RGBA{0xb0, 0x3f, 0xb6, 255}, // 4: Purple
		color.RGBA{0x4a, 0xc6, 0x4a, 255}, // 5: Green
		color.RGBA{0x37, 0x39, 0xc4, 255}, // 6: Blue
		color.RGBA{0xe4, 0xed, 0x4e, 255}, // 7: Yellow
		color.RGBA{0xb6, 0x59, 0x1c, 255}, // 8: Orange
		color.RGBA{0x68, 0x38, 0x08, 255}, // 9: Brown
		color.RGBA{0xea, 0x74, 0x6c, 255}, // A: Pink
		color.RGBA{0x4d, 0x4d, 0x4d, 255}, // B: Dark Grey
		color.RGBA{0x84, 0x84, 0x84, 255}, // C: Grey
		color.RGBA{0xa6, 0xfa, 0x9e, 255}, // D: Light Green
		color.RGBA{0x70, 0x7c, 0xe6, 255}, // E: Light Blue
		color.RGBA{0xb6, 0xb6, 0xb6, 255}, // F: Light Grey
	}
}

func ReadFile(fileName string) ([]byte, error) {
	bytes, err := os.ReadFile(fileName)
	if err != nil {
		log.Fatal(err)
	}
	return bytes, err
}

func ResetAllFlags(cmd *cobra.Command) {
	cmd.Flags().VisitAll(func(flag *pflag.Flag) {
		flag.Value.Set(flag.DefValue)
		flag.Changed = false
	})
	for _, subCmd := range cmd.Commands() {
		ResetAllFlags(subCmd)
	}
}
